# Supernote Private Cloud Add-on - Technical Documentation

This document provides technical details about the simplified Supernote Private Cloud Add-on that uses the official installation script.

## Architecture Overview

This add-on takes a fundamentally different approach from complex multi-container setups. Instead, it:

1. **Downloads** the official Supernote installation script
2. **Executes** it within a Docker environment
3. **Monitors** the resulting services

```
┌─────────────────────────────────────────────────────────────┐
│                    Home Assistant Host                      │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Supernote Add-on Container                 │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │              Docker-in-Docker                       │ │ │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │ │ │
│  │  │  │MariaDB  │ │ Redis   │ │Notelib  │ │Supernote│   │ │ │
│  │  │  │Container│ │Container│ │Container│ │ Service │   │ │ │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘   │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## How It Works

### 1. Installation Script Download
The add-on downloads the official script from:
```
https://supernote-private-cloud.supernote.com/cloud/install.sh
```

### 2. Docker-in-Docker Setup
- The add-on container runs Docker daemon
- Official script deploys containers within this environment
- All containers share the same network namespace

### 3. Service Management
The original script creates and manages:
- MariaDB database container
- Redis cache container  
- Notelib processing container
- Supernote main service container

## Configuration

### Add-on Configuration
```yaml
{
  "install_url": "https://supernote-private-cloud.supernote.com/cloud/install.sh",
  "auto_update": true,
  "log_level": "info", 
  "data_directory": "/share/supernote"
}
```

### Generated by Install Script
The official script creates:
- `docker-compose.yml` with service definitions
- `.dbenv` with auto-generated passwords
- Database initialization files
- Service configuration files

## Port Mapping

| Service | Port | Purpose |
|---------|------|---------|
| Supernote Web | 9888 | Main web interface |
| Supernote API | 8080 | REST API |
| Supernote Backend | 19071 | Backend services |
| Notelib | 6000 | Note processing |
| MariaDB | 3306 | Database |
| Redis | 6379 | Cache |

## Data Persistence

### Data Location
All data is stored in `/share/supernote/`:
```
/share/supernote/
├── docker-compose.yml    # Service configuration
├── .dbenv               # Database credentials
├── install.sh           # Downloaded install script
├── addon.log           # Add-on logs
├── db_data/            # Database files
├── redis_data/         # Redis persistence
├── logs/               # Application logs
├── recycle/            # Deleted files
└── convert/            # Note conversion temp files
```

### Backup Strategy
Since everything is in `/share/supernote/`, Home Assistant's built-in backup system will preserve:
- All configuration files
- Database data
- User uploads
- Service settings

## Installation Process

### Phase 1: Environment Setup
1. Create data directory structure
2. Start Docker daemon within container
3. Download official installation script

### Phase 2: Script Execution
1. Execute install.sh with proper environment
2. Script downloads container images
3. Script creates docker-compose.yml
4. Script generates database credentials
5. Script starts all services

### Phase 3: Service Monitoring
1. Wait for services to be ready
2. Monitor service health
3. Display access information

## Troubleshooting

### Installation Issues

**Script Download Fails**
```bash
# Check network connectivity
curl -I https://supernote-private-cloud.supernote.com/cloud/install.sh

# Verify DNS resolution
nslookup supernote-private-cloud.supernote.com
```

**Docker Issues**
```bash
# Check Docker daemon
docker info

# Check container status
docker ps -a

# Check service logs
docker-compose logs
```

### Service Issues

**Services Won't Start**
```bash
# Check the generated docker-compose.yml
cd /share/supernote
cat docker-compose.yml

# Try manual restart
docker-compose restart

# Check resource usage
docker stats
```

**Port Conflicts**
```bash
# Check what's using ports
netstat -tulpn | grep -E "(9888|8080|19071|6000|3306|6379)"

# Check if containers are running
docker ps --filter "status=running"
```

### Log Analysis

**Add-on Logs**
- Found in Home Assistant → Add-ons → Supernote Private Cloud → Logs
- Also saved to `/share/supernote/addon.log`

**Service Logs**  
- Generated by the install script
- Available via `docker-compose logs` in `/share/supernote/`

**Important Log Messages**
```
Installation script downloaded successfully
Supernote Private Cloud installation completed successfully
Service on port 9888 is ready
All services are healthy and running
```

## Advantages of This Approach

### ✅ Pros
- **Official**: Uses exact same script as manual installation
- **Simple**: Minimal custom code, maximum compatibility
- **Maintainable**: Updates come from Supernote automatically
- **Reliable**: Proven installation process
- **Complete**: All features from official installation

### ⚠️ Considerations
- **Resource Usage**: Docker-in-Docker adds overhead
- **Complexity**: Multiple containers within container
- **Debugging**: More layers to troubleshoot
- **Security**: Requires privileged container access

## Comparison with Custom Implementation

| Aspect | This Approach | Custom Implementation |
|--------|---------------|----------------------|
| Compatibility | 100% official | Depends on implementation |
| Updates | Automatic from Supernote | Manual update required |
| Features | All official features | Limited to implemented features |
| Maintenance | Minimal | High maintenance burden |
| Risk | Low (proven script) | High (custom code) |
| Complexity | Medium (Docker-in-Docker) | High (service orchestration) |

## Security Considerations

### Container Privileges
The add-on requires:
- `privileged: ["SYS_ADMIN", "NET_ADMIN"]`
- `docker_api: true`
- `full_access: true`

These are needed for Docker-in-Docker functionality.

### Network Security
- All services run in isolated container network
- Only exposed ports are accessible from host
- Internal communication uses Docker DNS

### Data Security
- Database passwords auto-generated by official script
- Configuration files have restricted permissions
- Data isolated in `/share/supernote/`

## Performance Optimization

### Resource Requirements
- **CPU**: 2+ cores recommended
- **RAM**: 4GB+ recommended (Docker-in-Docker overhead)
- **Storage**: 50GB+ for data and images
- **Network**: Stable internet for initial setup

### Optimization Tips
1. **Allocate sufficient resources** to Home Assistant
2. **Use SSD storage** for better database performance
3. **Ensure stable network** during installation
4. **Monitor resource usage** after installation

## Development and Testing

### Local Testing
```bash
# Test the add-on locally
docker build -t supernote-addon .
docker run -v /path/to/data:/share/supernote supernote-addon
```

### Debugging
```bash
# Enter running container
docker exec -it <container_id> /bin/bash

# Check running services
docker-compose ps

# View service logs
docker-compose logs -f
```

### Custom Modifications
To modify the installation:
1. Fork this repository
2. Modify the `run.sh` script
3. Change `install_url` to your custom script
4. Build and test

## Future Improvements

### Potential Enhancements
- Health check endpoints for better monitoring
- Automatic backup scheduling
- Resource usage monitoring
- Update notifications
- Custom configuration injection

### Limitations
- Dependent on official script availability
- Limited customization options
- Docker-in-Docker complexity
- Resource overhead

## Support and Community

### Getting Help
1. **Check logs** first (add-on and service logs)
2. **Review documentation** for common issues
3. **Search existing issues** on GitHub
4. **Create new issue** with full logs and details

### Contributing
- Report bugs and issues
- Suggest improvements
- Submit pull requests
- Help with documentation

---

This simplified approach prioritizes compatibility and maintainability over custom features, ensuring users get the full official Supernote Private Cloud experience within Home Assistant.